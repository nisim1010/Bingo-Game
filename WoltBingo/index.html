<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phrase Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            font-size: clamp(0.6rem, 2.5vw, 1rem);
            line-height: 1.2;
            word-break: break-word;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none;
        }
        .bingo-cell.marked {
            transform: scale(1.05);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60; 
        }
        .modal-content {
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
         .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out;
        }
        .leaderboard-entry:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .mini-card-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        .mini-cell {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 2px;
        }
        .rare-phrase-cell {
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

    <div id="app" class="relative w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <div id="auth-container" class="absolute top-4 right-4 text-right z-10">
            <div id="user-info" class="hidden items-center gap-4">
                <span id="user-display-name" class="text-sm text-gray-300"></span>
                <button id="logout-btn" class="bg-red-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-red-700 transition">Logout</button>
            </div>
            <div id="login-register-buttons">
                <button id="login-btn-nav" class="bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-700 transition">Login</button>
                <button id="register-btn-nav" class="bg-green-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-green-700 transition">Register</button>
            </div>
        </div>

        <div id="create-game-view" class="flex flex-col lg:flex-row gap-8 pt-12">
            <div class="flex-grow">
                <div class="text-center lg:text-left">
                    <h1 class="text-4xl sm:text-5xl font-bold text-blue-500 mb-4">Phrase Bingo</h1>
                    <p class="text-lg text-gray-400 mb-8">Create a new game. Enter 5 rare phrases and at least 25 common phrases.</p>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-grow bg-gray-800 p-6 rounded-lg shadow-md">
                        <label for="phrases-input" class="block text-sm font-medium text-gray-300 mb-2">Common Phrases (at least 25)</label>
                        <textarea id="phrases-input" class="w-full h-64 p-3 border border-gray-600 rounded-md bg-gray-700" placeholder="One per line..."></textarea>
                        <p id="phrase-count" class="text-sm text-gray-400 mt-2 text-left">0 phrases</p>
                    </div>
                    <div class="w-full md:w-1/3 bg-gray-800 p-6 rounded-lg shadow-md">
                        <label for="rare-phrases-input" class="block text-sm font-medium text-purple-400 mb-2">Ultra Rare Phrases (exactly 5)</label>
                        <textarea id="rare-phrases-input" class="w-full h-64 p-3 border border-gray-600 rounded-md bg-gray-700" placeholder="One per line..."></textarea>
                        <p id="rare-phrase-count" class="text-sm text-gray-400 mt-2 text-left">0 phrases</p>
                    </div>
                </div>
                <p id="error-message" class="text-red-500 mt-4 text-sm h-5 text-center"></p>
                <button id="create-game-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 mt-4 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Create Game & Get Link</button>
            </div>
            <div class="w-full lg:w-80 flex-shrink-0">
                 <h2 class="text-2xl font-bold text-center mb-4">üèÜ All-Time Wins</h2>
                 <div id="leaderboard" class="bg-gray-800 p-4 rounded-lg shadow-md h-96 overflow-y-auto"></div>
                 
                 <div id="active-games-container" class="hidden">
                    <h2 class="text-2xl font-bold text-center mt-8 mb-4">üé≤ Active Games</h2>
                    <div id="active-games-list" class="bg-gray-800 p-4 rounded-lg shadow-md h-48 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">No active games found.</p>
                    </div>
                 </div>

                 <h2 class="text-2xl font-bold text-center mt-8 mb-4">üìú Recent Phrase Sets</h2>
                 <div id="recent-games" class="bg-gray-800 p-4 rounded-lg shadow-md h-64 overflow-y-auto"></div>
            </div>
        </div>

        <div id="link-game-view" class="hidden text-center pt-12">
             <h2 class="text-3xl font-bold mb-4">Your Game is Ready!</h2>
            <p class="text-gray-400 mb-6">Share this link with your teammates to have them join the game.</p>
            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
                <input id="game-link-input" type="text" class="flex-grow p-3 border border-gray-600 rounded-md bg-gray-700 text-gray-200" readonly>
                <button id="copy-link-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Copy</button>
            </div>
             <button id="go-to-my-card-btn" class="mt-6 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">Go to My Bingo Card</button>
        </div>
        
        <div id="join-game-view" class="hidden text-center pt-12">
            <h2 class="text-3xl font-bold mb-4">Join Bingo Game</h2>
             <p class="text-gray-400 mb-6">Enter your name to join the game as a guest.</p>
             <div class="bg-gray-800 p-6 rounded-lg shadow-md max-w-md mx-auto">
                 <input id="player-name-input" type="text" class="w-full p-3 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-gray-700 text-gray-200" placeholder="Your Name">
                 <button id="join-game-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">Join and View Card</button>
             </div>
        </div>

        <div id="board-game-view" class="hidden pt-12">
            <div class="grid grid-cols-1 lg:grid-cols-[200px_1fr_256px] gap-8">
                <div class="order-2 lg:order-1">
                     <h2 class="text-2xl font-bold text-center mb-4 text-purple-400">Ultra Rare</h2>
                     <div id="rare-phrases-container" class="space-y-3"></div>
                </div>
                <div class="order-1 lg:order-2">
                    <h1 class="text-3xl sm:text-4xl font-bold text-blue-500 mb-2 text-center">Your Bingo Card</h1>
                    <div class="max-w-xl mx-auto">
                        <div id="bingo-card-container" class="bingo-card shadow-lg p-2 rounded-lg bg-gray-800"></div>
                    </div>
                    <div class="text-center mt-6">
                         <button id="bingo-btn" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-4 px-10 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all transform hover:scale-110 text-2xl tracking-wider">BINGO!</button>
                    </div>
                     <p class="text-sm text-gray-400 mt-8 text-center">
                        Playing as: <strong id="player-name-display" class="font-mono bg-gray-700 px-2 py-1 rounded"></strong>
                        <span class="mx-2">|</span>
                        Score: <strong id="player-score-display" class="font-mono bg-gray-700 px-2 py-1 rounded">0</strong>
                     </p>
                </div>
                <div class="order-3 lg:order-3">
                     <h2 class="text-2xl font-bold text-center mb-4">Live Progress</h2>
                     <div id="live-players-container" class="bg-gray-800 p-4 rounded-lg shadow-md h-[450px] overflow-y-auto space-y-4"></div>
                </div>
            </div>
        </div>
        
        <!-- Auth Modal -->
        <div id="auth-modal" class="hidden modal-backdrop bg-black bg-opacity-70">
            <div class="modal-content bg-gray-800 text-left w-full max-w-sm relative">
                <h2 id="auth-modal-title" class="text-2xl font-bold text-gray-100 mb-4">Login</h2>
                <div class="space-y-4">
                    <input id="auth-display-name" type="text" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700" placeholder="Display Name">
                    <input id="auth-email" type="email" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700" placeholder="Email">
                    <input id="auth-password" type="password" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700" placeholder="Password">
                </div>
                <p id="auth-error" class="text-red-500 text-sm mt-2 h-5"></p>
                <button id="auth-submit-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Login</button>
                <p class="text-xs text-gray-400 mt-4 text-center">
                    <span id="auth-toggle-text">Don't have an account?</span>
                    <button id="auth-toggle-btn" class="text-blue-400 hover:underline">Register</button>
                </p>
                 <button id="auth-close-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
        </div>
        <!-- Winner Modal -->
        <div id="winner-modal" class="hidden modal-backdrop bg-black bg-opacity-70">
            <div class="modal-content bg-gray-800 text-center">
                <h2 class="text-4xl font-bold text-amber-500 mb-4">BINGO!</h2>
                <p class="text-lg text-gray-300">A winner has been declared!</p>
                <p class="mt-4 text-xl"><strong id="winner-name" class="text-blue-400"></strong> is the Bingo champion!</p>
                <button id="close-modal-btn" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Play Again</button>
            </div>
        </div>
        <!-- Message Modal -->
        <div id="message-modal" class="hidden modal-backdrop bg-black bg-opacity-70">
            <div class="modal-content bg-gray-800 text-center">
                <h2 id="message-modal-title" class="text-2xl font-bold text-gray-100 mb-4">Message</h2>
                <p id="message-modal-text" class="text-lg text-gray-300">This is a message.</p>
                <button id="message-modal-close-btn" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, onSnapshot, updateDoc, runTransaction, query, orderBy, limit, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Make sure this config is replaced with your own!
        const firebaseConfig = {
            apiKey: "AIzaSyDi4lqp8VnQK6OCWdTJ7nLg0MekDtuQqoY",
            authDomain: "phrasebingo.firebaseapp.com",
            projectId: "phrasebingo",
            storageBucket: "phrasebingo.firebasestorage.app",
            messagingSenderId: "67899629832",
            appId: "1:67899629832:web:bebc5dcb58dd89c0a90cbd",
            measurementId: "G-CGR9LQ8GJ3"
        };
        
        // --- App State ---
        let app, auth, db;
        let currentUser = null; 
        let gameId, playerId;
        let unsubscribeGame, unsubscribeLeaderboard, unsubscribePlayers, unsubscribeUser;
        let isRegisterMode = false;

        // --- UI Elements ---
        const authContainer = document.getElementById('auth-container');
        const userInfo = document.getElementById('user-info');
        const userDisplayName = document.getElementById('user-display-name');
        const logoutBtn = document.getElementById('logout-btn');
        const loginRegisterButtons = document.getElementById('login-register-buttons');
        const loginBtnNav = document.getElementById('login-btn-nav');
        const registerBtnNav = document.getElementById('register-btn-nav');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authDisplayName = document.getElementById('auth-display-name');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authError = document.getElementById('auth-error');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authCloseBtn = document.getElementById('auth-close-btn');
        const phrasesInput = document.getElementById('phrases-input');
        const phraseCount = document.getElementById('phrase-count');
        const errorMessage = document.getElementById('error-message');
        const createGameBtn = document.getElementById('create-game-btn');
        const gameLinkInput = document.getElementById('game-link-input');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const goToMyCardBtn = document.getElementById('go-to-my-card-btn');
        const playerNameInput = document.getElementById('player-name-input');
        const joinGameBtn = document.getElementById('join-game-btn');
        const bingoCardContainer = document.getElementById('bingo-card-container');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerScoreDisplay = document.getElementById('player-score-display');
        const bingoBtn = document.getElementById('bingo-btn');
        const winnerModal = document.getElementById('winner-modal');
        const winnerName = document.getElementById('winner-name');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
        const leaderboardContainer = document.getElementById('leaderboard');
        const recentGamesContainer = document.getElementById('recent-games');
        const livePlayersContainer = document.getElementById('live-players-container');
        const rarePhrasesInput = document.getElementById('rare-phrases-input');
        const rarePhraseCount = document.getElementById('rare-phrase-count');
        const rarePhrasesContainer = document.getElementById('rare-phrases-container');
        const activeGamesContainer = document.getElementById('active-games-container');
        const activeGamesList = document.getElementById('active-games-list');
        
        // --- Core Functions ---

        function showMessage(title, text) {
            messageModalTitle.textContent = title;
            messageModalText.textContent = text;
            messageModal.classList.remove('hidden');
        }
        
        function updateAuthUI(isLoggedIn) {
            if (isLoggedIn) {
                userDisplayName.textContent = `${currentUser.displayName}`;
                userInfo.classList.remove('hidden');
                loginRegisterButtons.classList.add('hidden');
            } else {
                userInfo.classList.add('hidden');
                loginRegisterButtons.classList.remove('hidden');
            }
        }
        
        function openAuthModal(isRegister) {
            isRegisterMode = isRegister;
            authModal.classList.remove('hidden');
            setupAuthModal();
        }

        function setupAuthModal() {
            authError.textContent = '';
            authDisplayName.style.display = isRegisterMode ? 'block' : 'none';
            authModalTitle.textContent = isRegisterMode ? 'Register' : 'Login';
            authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
            authToggleText.textContent = isRegisterMode ? 'Already have an account?' : "Don't have an account?";
            authToggleBtn.textContent = isRegisterMode ? 'Login' : 'Register';
        }

        async function handleAuthSubmit() {
            const email = authEmail.value;
            const password = authPassword.value;
            const displayName = authDisplayName.value;
            authError.textContent = '';

            try {
                if (isRegisterMode) {
                    if (!displayName || !email || !password) { authError.textContent = 'All fields are required.'; return; }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { displayName, activeGames: [] });
                } else {
                    if (!email || !password) { authError.textContent = 'All fields are required.'; return; }
                    await signInWithEmailAndPassword(auth, email, password);
                }
                authModal.classList.add('hidden');
            } catch (error) {
                authError.textContent = error.message;
            }
        }
        
        function handleRouting() {
            const params = new URLSearchParams(window.location.search);
            const urlGameId = params.get('game');
            
            // THE FIX: Prioritize the URL gameId on page load, but don't overwrite
            // the gameId if it was already set by the 'Rejoin' button.
            if (urlGameId) {
                gameId = urlGameId;
            }
            
            if (gameId) {
                joinGameFlow();
            } else {
                showView('create');
            }
        }

        function joinGameFlow() {
            if (currentUser) {
                joinGame(currentUser.displayName, currentUser.uid);
            } else {
                const guestName = playerNameInput.value.trim();
                if(gameId && guestName) {
                    joinGame(guestName, `guest-${Date.now()}`);
                } else {
                    showView('join');
                }
            }
        }

        function showView(view) {
            const viewIds = ['create-game-view', 'link-game-view', 'join-game-view', 'board-game-view', 'loading-spinner'];
            viewIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        
            if (view === 'loading') {
                document.getElementById('loading-spinner').classList.remove('hidden');
            } else {
                const viewElement = document.getElementById(`${view}-game-view`);
                if (viewElement) {
                    viewElement.classList.remove('hidden');
                } else {
                    console.error(`View element not found for: ${view}-game-view`);
                }
            }
        }
        
        function getPhrasesFromInput() {
            return phrasesInput.value.split('\n').map(p => p.trim()).filter(p => p.length > 0);
        }

        function getRarePhrasesFromInput() {
            return rarePhrasesInput.value.split('\n').map(p => p.trim()).filter(p => p.length > 0);
        }

        function updatePhraseCount() {
            const commonPhrases = getPhrasesFromInput();
            const rarePhrases = getRarePhrasesFromInput();
            phraseCount.textContent = `${commonPhrases.length} phrases`;
            rarePhraseCount.textContent = `${rarePhrases.length} phrases`;

            const isCommonValid = commonPhrases.length >= 25;
            const isRareValid = rarePhrases.length === 5;
            
            createGameBtn.disabled = !(isCommonValid && isRareValid);

            if (!isCommonValid && !isRareValid) {
                errorMessage.textContent = 'Need at least 25 common phrases and exactly 5 rare phrases.';
            } else if (!isCommonValid) {
                errorMessage.textContent = 'You need at least 25 common phrases.';
            } else if (!isRareValid) {
                errorMessage.textContent = 'You need exactly 5 rare phrases.';
            } else {
                errorMessage.textContent = '';
            }
        }
        
        async function createNewGame() {
            const commonPhrases = getPhrasesFromInput();
            const rarePhrasesRaw = getRarePhrasesFromInput();

            if (commonPhrases.length < 25 || rarePhrasesRaw.length !== 5) {
                showMessage("Invalid Phrases", "Please ensure you have at least 25 common phrases and exactly 5 rare phrases.");
                return;
            }
            
            showView('loading');

            const rarePhrases = rarePhrasesRaw.map(phrase => ({
                text: phrase,
                claimedBy: null,
                claimedByName: null
            }));

            try {
                const gameDocRef = await addDoc(collection(db, "bingoGames"), {
                    creatorId: currentUser ? currentUser.uid : 'guest',
                    createdAt: serverTimestamp(),
                    allPhrases: commonPhrases,
                    rarePhrases: rarePhrases,
                    winner: null
                });

                gameId = gameDocRef.id;
                const newUrl = `${window.location.origin}${window.location.pathname}?game=${gameId}`;
                
                gameLinkInput.value = newUrl;
                showView('link');

            } catch (error) {
                console.error("Error creating game:", error);
                showMessage("Error", "There was an error creating your game.");
                showView('create');
            }
        }
        
        function copyGameLink() {
            gameLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = 'Copied!';
            setTimeout(() => { copyLinkBtn.textContent = 'Copy'; }, 2000);
        }

        async function joinGame(pName, pId) {
            playerId = pId;
            showView('loading');
            
            try {
                const gameRef = doc(db, "bingoGames", gameId);
                const gameDoc = await getDoc(gameRef);

                if (!gameDoc.exists()) {
                    showView('create'); 
                    showMessage("Game Not Found", "The game link is broken or doesn't exist.");
                    return;
                }

                const gameData = gameDoc.data();
                listenForGameUpdates(gameId);
                listenForPlayerUpdates(gameId);
                
                playerNameDisplay.textContent = pName;
                const playerRef = doc(db, `bingoGames/${gameId}/players`, playerId);
                const playerDoc = await getDoc(playerRef);

                if (playerDoc.exists()) {
                    await updateDoc(playerRef, { playerName: pName });
                    renderBingoCard(JSON.parse(playerDoc.data().card), playerDoc.data().markedCells);
                } else {
                    const newCard = generateBingoCard(gameData.allPhrases);
                    const initialMarkedCells = Array(5).fill("FFFFF");
                    await setDoc(playerRef, {
                        playerName: pName,
                        card: JSON.stringify(newCard),
                        markedCells: initialMarkedCells,
                        score: 0
                    });
                    renderBingoCard(newCard, initialMarkedCells);
                }

                if (currentUser) {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { activeGames: arrayUnion(gameId) });
                }
                
                showView('board');
            } catch (error) {
                console.error("Error joining game:", error);
                showView('create');
            }
        }
        
        function generateBingoCard(phrases) {
            const shuffled = [...phrases].sort(() => 0.5 - Math.random());
            const cardPhrases = shuffled.slice(0, 25);
            const card = [];
            for (let i = 0; i < 5; i++) {
                card.push(cardPhrases.slice(i * 5, i * 5 + 5));
            }
            return card;
        }

        function renderBingoCard(card, markedCells) {
            bingoCardContainer.innerHTML = "";
            card.forEach((row, r) => {
                row.forEach((phrase, c) => {
                    const cell = document.createElement("div");
                    cell.className = "bingo-cell bg-gray-700 text-gray-200";
                    if (markedCells && markedCells[r] && markedCells[r][c] === 'T') {
                        cell.classList.add('marked', 'bg-blue-500', 'text-white');
                    }
                    cell.textContent = phrase;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener("click", () => toggleCell(r, c));
                    bingoCardContainer.appendChild(cell);
                });
            });
        }
        
        function calculateScore(markedCells) {
            let markedCount = 0;
            let connectionCount = 0;

            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    if (markedCells[r][c] === 'T') {
                        markedCount++;
                        if (c < 4 && markedCells[r][c + 1] === 'T') connectionCount++;
                        if (r < 4 && markedCells[r + 1][c] === 'T') connectionCount++;
                    }
                }
            }
            return (markedCount * 100) + (connectionCount * 50);
        }

        async function toggleCell(row, col) {
            const cell = document.querySelector(`.bingo-cell[data-row='${row}'][data-col='${col}']`);
            const isMarked = cell.classList.toggle("marked");
            cell.classList.toggle("bg-gray-700", !isMarked);
            cell.classList.toggle("bg-blue-500", isMarked);
            cell.classList.toggle("text-white", isMarked);
            try {
                const playerRef = doc(db, `bingoGames/${gameId}/players`, playerId);
                const playerDoc = await getDoc(playerRef);
                if (playerDoc.exists()) {
                    const markedCells = playerDoc.data().markedCells;
                    const rowStr = markedCells[row].split('');
                    rowStr[col] = isMarked ? 'T' : 'F';
                    markedCells[row] = rowStr.join('');
                    const newScore = calculateScore(markedCells);
                    await updateDoc(playerRef, { markedCells, score: newScore });
                }
            } catch (error) {
                console.error("Error updating cell:", error);
                cell.classList.toggle("marked", !isMarked);
                cell.classList.toggle("bg-gray-700", isMarked);
                cell.classList.toggle("bg-blue-500", !isMarked);
                cell.classList.toggle("text-white", !isMarked);
                showMessage("Sync Error", "Could not save your move.");
            }
        }
        
        async function checkBingo() {
            const playerRef = doc(db, `bingoGames/${gameId}/players`, playerId);
            const playerDoc = await getDoc(playerRef);
            if (!playerDoc.exists()) return;

            const playerData = playerDoc.data();
            const markedCells = playerData.markedCells;
            let hasBingo = false;

            for (let i = 0; i < 5; i++) {
                if (markedCells[i] === "TTTTT" || markedCells.every(row => row[i] === 'T')) {
                    hasBingo = true;
                    break;
                }
            }
            if (!hasBingo) {
                if (markedCells.every((r, i) => r[i] === 'T') || markedCells.every((r, i) => r[4 - i] === 'T')) {
                    hasBingo = true;
                }
            }
            
            if (hasBingo) {
                const gameRef = doc(db, "bingoGames", gameId);
                const winnerId = currentUser ? currentUser.uid : playerData.playerName;
                await updateDoc(gameRef, { winner: playerData.playerName });
                await updateLeaderboard(playerData.playerName, winnerId);
                await cleanupEndedGame(gameId);
            } else {
                showMessage("Not a Bingo!", "You don't have 5 in a row yet.");
            }
        }

        async function cleanupEndedGame(endedGameId) {
            const playersSnapshot = await getDocs(collection(db, `bingoGames/${endedGameId}/players`));
            
            playersSnapshot.forEach(async (playerDoc) => {
                const pId = playerDoc.id;
                if (!pId.startsWith('guest-')) {
                    const userDocRef = doc(db, "users", pId);
                    try {
                        await updateDoc(userDocRef, {
                            activeGames: arrayRemove(endedGameId)
                        });
                    } catch (error) {
                        console.error(`Failed to remove game from user ${pId}'s list:`, error);
                    }
                }
            });
        }
        
        async function updateLeaderboard(winnerName, winnerId) {
            if (!winnerId.startsWith('guest')) {
                const leaderboardRef = doc(db, "leaderboard", winnerId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const leaderboardDoc = await transaction.get(leaderboardRef);
                        if (!leaderboardDoc.exists()) {
                            transaction.set(leaderboardRef, { wins: 1, displayName: winnerName });
                        } else {
                            const newWins = (leaderboardDoc.data().wins || 0) + 1;
                            transaction.update(leaderboardRef, { wins: newWins, displayName: winnerName });
                        }
                    });
                } catch (e) { console.error("Leaderboard transaction failed: ", e); }
            }
        }

        function listenForLeaderboardUpdates() {
            const q = query(collection(db, "leaderboard"), orderBy("wins", "desc"));
            unsubscribeLeaderboard = onSnapshot(q, (querySnapshot) => {
                const players = [];
                querySnapshot.forEach((doc) => players.push({ id: doc.id, ...doc.data() }));
                
                leaderboardContainer.innerHTML = ''; 
                if (players.length === 0) {
                    leaderboardContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No winners yet!</p>';
                    return;
                }

                players.forEach(player => {
                    const entry = document.createElement('div');
                    entry.className = 'leaderboard-entry';
                    const nameEl = document.createElement('span');
                    nameEl.className = 'leaderboard-name';
                    nameEl.textContent = player.displayName;
                    const scoreEl = document.createElement('span');
                    scoreEl.className = 'leaderboard-score';
                    scoreEl.textContent = player.wins;
                    entry.appendChild(nameEl);
                    entry.appendChild(scoreEl);
                    leaderboardContainer.appendChild(entry);
                });
            });
        }
        
        function listenForRecentGames() {
            const q = query(collection(db, "bingoGames"), orderBy("createdAt", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                recentGamesContainer.innerHTML = '';
                if (snapshot.empty) {
                    recentGamesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No recent games found.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const gameData = doc.data();
                    const entry = document.createElement('div');
                    entry.className = 'bg-gray-700 p-3 rounded-md mb-2 flex justify-between items-center';
                    const dateEl = document.createElement('span');
                    dateEl.className = 'text-sm text-gray-400';
                    dateEl.textContent = gameData.createdAt?.toDate().toLocaleDateString() || 'Recent Game';
                    const useBtn = document.createElement('button');
                    useBtn.className = 'bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-700';
                    useBtn.textContent = 'Use';
                    useBtn.onclick = () => {
                        phrasesInput.value = gameData.allPhrases.join('\n');
                        if(gameData.rarePhrases) {
                            rarePhrasesInput.value = gameData.rarePhrases.map(p => p.text).join('\n');
                        }
                        updatePhraseCount();
                        window.scrollTo(0, 0); 
                    };
                    entry.appendChild(dateEl);
                    entry.appendChild(useBtn);
                    recentGamesContainer.appendChild(entry);
                });
            }, (error) => {
                console.error("Error fetching recent games:", error);
                recentGamesContainer.innerHTML = '<p class="text-red-500 text-center py-4">Could not load games.</p>';
            });
        }

        function listenForGameUpdates(id) {
            unsubscribeGame = onSnapshot(doc(db, "bingoGames", id), (doc) => {
                if (!doc.exists()) return;
                const gameData = doc.data();
                if (gameData.winner && winnerModal.classList.contains('hidden')) {
                    winnerName.textContent = gameData.winner;
                    winnerModal.classList.remove('hidden');
                    confetti({ particleCount: 150, spread: 180, origin: { y: 0.6 } });
                }
                if (gameData.rarePhrases) {
                    renderRarePhrases(gameData.rarePhrases);
                }
            });
        }

        function listenForPlayerUpdates(id) {
            unsubscribePlayers = onSnapshot(query(collection(db, `bingoGames/${id}/players`)), (snapshot) => {
                const players = [];
                snapshot.forEach((doc) => players.push({ id: doc.id, ...doc.data() }));
                renderPlayerProgress(players);
            });
        }

        function renderPlayerProgress(players) {
            livePlayersContainer.innerHTML = '';
            if (players.length === 0) {
                livePlayersContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Waiting for players...</p>';
                return;
            }
            players.sort((a, b) => a.playerName.localeCompare(b.playerName));
            players.forEach(player => {
                if (player.id === playerId) {
                    playerScoreDisplay.textContent = player.score || 0;
                }
                const playerCard = document.createElement('div');
                playerCard.className = 'bg-gray-700 p-3 rounded-md';
                const header = document.createElement('div');
                header.className = 'flex justify-between items-baseline text-sm mb-2';
                const nameEl = document.createElement('p');
                nameEl.className = 'font-bold truncate';
                nameEl.textContent = player.playerName;
                const scoreEl = document.createElement('p');
                scoreEl.className = 'text-blue-400 font-mono';
                scoreEl.textContent = player.score || 0;
                header.appendChild(nameEl);
                header.appendChild(scoreEl);
                playerCard.appendChild(header);
                const miniGrid = document.createElement('div');
                miniGrid.className = 'mini-card-grid';
                for (let r = 0; r < 5; r++) {
                    for (let c = 0; c < 5; c++) {
                        const miniCell = document.createElement('div');
                        const isMarked = player.markedCells && player.markedCells[r] && player.markedCells[r][c] === 'T';
                        miniCell.className = `mini-cell ${isMarked ? 'bg-blue-500' : 'bg-gray-600'}`;
                        miniGrid.appendChild(miniCell);
                    }
                }
                playerCard.appendChild(miniGrid);
                livePlayersContainer.appendChild(playerCard);
            });
        }

        function renderRarePhrases(phrases) {
            rarePhrasesContainer.innerHTML = '';
            phrases.forEach((phrase, index) => {
                const cell = document.createElement('div');
                cell.className = 'rare-phrase-cell';

                if (phrase.claimedBy) {
                    if (phrase.claimedBy === playerId) {
                        cell.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
                        const textEl = document.createElement('p');
                        textEl.textContent = phrase.text;
                        const claimerEl = document.createElement('p');
                        claimerEl.className = 'text-xs text-green-200 mt-1';
                        claimerEl.textContent = `(Claimed by you)`;
                        cell.appendChild(textEl);
                        cell.appendChild(claimerEl);
                        cell.addEventListener('click', () => unclaimRarePhrase(index));
                    } else {
                        cell.classList.add('bg-gray-700', 'cursor-not-allowed');
                        const textEl = document.createElement('p');
                        textEl.className = 'text-gray-400 line-through';
                        textEl.textContent = phrase.text;
                        const claimerEl = document.createElement('p');
                        claimerEl.className = 'text-xs text-blue-400 mt-1';
                        claimerEl.textContent = `Claimed by ${phrase.claimedByName}`;
                        cell.appendChild(textEl);
                        cell.appendChild(claimerEl);
                    }
                } else {
                    cell.classList.add('bg-purple-600', 'hover:bg-purple-700', 'cursor-pointer');
                    cell.textContent = phrase.text;
                    cell.addEventListener('click', () => claimRarePhrase(index), { once: true });
                }
                rarePhrasesContainer.appendChild(cell);
            });
        }

        async function claimRarePhrase(index) {
            try {
                await runTransaction(db, async (transaction) => {
                    const gameRef = doc(db, "bingoGames", gameId);
                    const playerRef = doc(db, `bingoGames/${gameId}/players`, playerId);
                    const gameDoc = await transaction.get(gameRef);
                    const playerDoc = await transaction.get(playerRef);
                    if (!gameDoc.exists() || !playerDoc.exists()) throw "Game or player not found.";
                    const gameData = gameDoc.data();
                    const playerData = playerDoc.data();
                    if (gameData.rarePhrases[index].claimedBy === null) {
                        const updatedRarePhrases = [...gameData.rarePhrases];
                        updatedRarePhrases[index] = { ...updatedRarePhrases[index], claimedBy: playerId, claimedByName: playerData.playerName };
                        const newScore = (playerData.score || 0) + 300;
                        transaction.update(gameRef, { rarePhrases: updatedRarePhrases });
                        transaction.update(playerRef, { score: newScore });
                    } else {
                        showMessage("Too Late!", "Someone else just claimed that rare phrase.");
                    }
                });
            } catch (error) {
                console.error("Failed to claim rare phrase:", error);
                showMessage("Error", "Could not claim the phrase. Please try again.");
            }
        }

        async function unclaimRarePhrase(index) {
            try {
                await runTransaction(db, async (transaction) => {
                    const gameRef = doc(db, "bingoGames", gameId);
                    const playerRef = doc(db, `bingoGames/${gameId}/players`, playerId);
                    const gameDoc = await transaction.get(gameRef);
                    const playerDoc = await transaction.get(playerRef);
                    if (!gameDoc.exists() || !playerDoc.exists()) throw "Game or player not found.";
                    const gameData = gameDoc.data();
                    const playerData = playerDoc.data();
                    if (gameData.rarePhrases[index].claimedBy === playerId) {
                        const updatedRarePhrases = [...gameData.rarePhrases];
                        updatedRarePhrases[index] = { ...updatedRarePhrases[index], claimedBy: null, claimedByName: null };
                        const newScore = (playerData.score || 0) - 300;
                        transaction.update(gameRef, { rarePhrases: updatedRarePhrases });
                        transaction.update(playerRef, { score: newScore });
                    }
                });
            } catch (error) {
                console.error("Failed to unclaim rare phrase:", error);
                showMessage("Error", "Could not unclaim the phrase. Please try again.");
            }
        }

        async function renderActiveGamesList(gameIds) {
            activeGamesList.innerHTML = '';
            if (!gameIds || gameIds.length === 0) {
                activeGamesList.innerHTML = '<p class="text-gray-500 text-center py-4">No active games found.</p>';
                return;
            }
            const gamePromises = gameIds.map(id => getDoc(doc(db, "bingoGames", id)));
            const gameDocs = await Promise.all(gamePromises);
            
            // Clear again in case of async updates
            activeGamesList.innerHTML = '';

            gameDocs.forEach(gameDoc => {
                if (gameDoc.exists()) {
                    const gameData = gameDoc.data();
                    const currentGameId = gameDoc.id;
                    const entry = document.createElement('div');
                    entry.className = 'bg-gray-700 p-3 rounded-md mb-2 flex justify-between items-center';
                    const dateEl = document.createElement('span');
                    dateEl.className = 'text-sm text-gray-400';
                    dateEl.textContent = `Game from ${gameData.createdAt?.toDate().toLocaleDateString() || 'Recent'}`;
                    const rejoinBtn = document.createElement('button');
                    rejoinBtn.className = 'bg-green-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-green-700';
                    rejoinBtn.textContent = 'Rejoin';
                    
                    // THE FIX: Instead of reloading the page, just set the state and call the routing function.
                    rejoinBtn.onclick = () => {
                        gameId = currentGameId;
                        handleRouting();
                    };

                    entry.appendChild(dateEl);
                    entry.appendChild(rejoinBtn);
                    activeGamesList.appendChild(entry);
                }
            });
        }

        function listenForUserUpdates(uid) {
            const userDocRef = doc(db, "users", uid);
            unsubscribeUser = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    renderActiveGamesList(doc.data().activeGames || []);
                }
            });
        }
        
        function setupEventListeners() {
            loginBtnNav.addEventListener('click', () => openAuthModal(false));
            registerBtnNav.addEventListener('click', () => openAuthModal(true));
            logoutBtn.addEventListener('click', () => signOut(auth));
            authCloseBtn.addEventListener('click', () => authModal.classList.add('hidden'));
            authToggleBtn.addEventListener('click', () => {
                isRegisterMode = !isRegisterMode;
                setupAuthModal();
            });
            authSubmitBtn.addEventListener('click', handleAuthSubmit);
            phrasesInput.addEventListener('input', updatePhraseCount);
            rarePhrasesInput.addEventListener('input', updatePhraseCount);
            createGameBtn.addEventListener('click', createNewGame);
            copyLinkBtn.addEventListener('click', copyGameLink);
            goToMyCardBtn.addEventListener('click', joinGameFlow);
            joinGameBtn.addEventListener('click', () => {
                const guestName = playerNameInput.value.trim();
                if (guestName) {
                    joinGame(guestName, `guest-${Date.now()}`);
                } else {
                    showMessage("Name Required", "Please enter a name to join as a guest.");
                }
            });
            bingoBtn.addEventListener('click', checkBingo);
            closeModalBtn.addEventListener('click', () => {
                if (unsubscribeGame) unsubscribeGame();
                if (unsubscribePlayers) unsubscribePlayers();
                window.location.href = window.location.origin + window.location.pathname;
            });
            messageModalCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        }

        // --- Entry Point ---
        function main() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) { console.error("Firebase init failed:", e); return; }

            onAuthStateChanged(auth, async user => {
                if (unsubscribeUser) unsubscribeUser();

                if (user && !user.isAnonymous) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    updateAuthUI(true);
                    listenForUserUpdates(user.uid);
                    activeGamesContainer.classList.remove('hidden');
                } else {
                    currentUser = null;
                    updateAuthUI(false);
                    activeGamesContainer.classList.add('hidden');
                }
                handleRouting();
            });

            listenForLeaderboardUpdates();
            listenForRecentGames();
            setupEventListeners();
        }
        
        main();
    </script>
</body>
</html>



